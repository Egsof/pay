<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pembayaran Limit - Space Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root {
            --neon-blue: #00f2ff;
            --neon-purple: #bc13fe;
            --glass-bg: rgba(23, 25, 40, 0.90);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #ffffff;
            --text-secondary: #a0a0c0;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            min-height: 100vh;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 40px 15px;
            overflow-y: auto;
            color: var(--text-main);
        }

        .stars-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
        .star { position: absolute; background: white; border-radius: 50%; animation: twinkle infinite alternate; }
        @keyframes twinkle { from { opacity: 0.3; transform: scale(1); } to { opacity: 1; transform: scale(1.5); } }

        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 2rem;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            text-align: center;
            position: relative;
            z-index: 10;
            margin: auto; 
        }

        h1 { 
            font-size: 1.5rem; 
            font-weight: 700; 
            margin: 0 0 5px 0; 
            color: #fff;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        .price-tag {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--neon-blue);
            text-shadow: 0 0 20px rgba(0, 242, 255, 0.4);
            margin: 10px 0 5px 0;
            line-height: 1.2;
            transition: all 0.3s ease;
        }

        .original-price {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 15px;
            font-style: italic;
        }

        .badge-packet {
            background: rgba(188, 19, 254, 0.15);
            color: #e08aff;
            border: 1px solid rgba(188, 19, 254, 0.4);
            padding: 6px 18px;
            border-radius: 50px;
            font-size: 0.95rem;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 20px;
            box-shadow: 0 0 10px rgba(188, 19, 254, 0.2);
        }

        /* --- COUNTRY SELECTOR --- */
        .country-wrapper {
            margin-bottom: 20px;
            text-align: left;
        }
        
        select.country-select {
            width: 100%;
            padding: 12px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            color: #fff;
            font-size: 1rem;
            font-family: 'Poppins', sans-serif;
            outline: none;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%2300f2ff%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 0.65em auto;
        }
        select.country-select:focus {
            border-color: var(--neon-blue);
            box-shadow: 0 0 15px rgba(0, 242, 255, 0.2);
        }

        /* --- QR AREA & ANIMATION --- */
        #qris-area {
            display: none;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.6s ease, transform 0.6s ease;
        }
        
        #qris-area.show {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        #qrcode {
            background: #fff;
            padding: 12px;
            border-radius: 16px;
            margin: 0 auto 25px auto;
            width: fit-content;
            box-shadow: 0 0 30px rgba(0, 242, 255, 0.1);
        }
        #qrcode img { display: block; max-width: 100%; height: auto; }

        .instruction-box {
            text-align: left;
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 12px;
            font-size: 0.85rem;
            color: #ccc;
            margin-bottom: 25px;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .instruction-box strong { color: #fff; display: block; margin-bottom: 5px; }
        .instruction-box ol { padding-left: 20px; margin: 0; }
        .instruction-box li { margin-bottom: 4px; }

        .input-wrapper { text-align: left; margin-bottom: 20px; }
        .label-custom { display: block; font-size: 0.9rem; margin-bottom: 8px; font-weight: 600; color: #fff; }
        .input-custom {
            width: 100%;
            padding: 14px;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: #fff;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            outline: none;
            transition: all 0.3s ease;
        }
        .input-custom:focus {
            border-color: var(--neon-blue);
            box-shadow: 0 0 15px rgba(0, 242, 255, 0.2);
            background: rgba(0, 0, 0, 0.6);
        }
        .helper-text { font-size: 0.75rem; color: var(--text-secondary); margin-top: 6px; }

        /* --- BUTTON STYLE UPDATED --- */
        .btn-wa {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 16px;
            background: linear-gradient(90deg, #11998e, #38ef7d);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            text-decoration: none;
            gap: 10px;
            box-shadow: 0 5px 20px rgba(56, 239, 125, 0.3);
            transition: transform 0.2s, background 0.3s;
            text-transform: uppercase;
        }
        .btn-wa:active { transform: scale(0.98); }
        .btn-wa svg { width: 22px; height: 22px; fill: white; }

        /* Style untuk tombol disabled */
        .btn-wa:disabled {
            background: #555 !important;
            cursor: not-allowed;
            box-shadow: none;
            opacity: 0.6;
            transform: none;
        }

        .note-footer { margin-top: 15px; font-size: 0.75rem; color: var(--text-secondary); opacity: 0.7; }
        #error-view { display: none; text-align: center; margin-top: 50px; }
        
        .error-code { font-size: 4rem; font-weight: bold; color: #ff4757; margin: 0; text-shadow: 0 0 20px rgba(255, 71, 87, 0.5); }
        .error-msg { font-size: 1.2rem; margin-bottom: 20px; }

        @media (max-width: 380px) {
            .card { padding: 1.5rem 1rem; } 
            .price-tag { font-size: 1.8rem; }
            h1 { font-size: 1.3rem; }
        }
    </style>
</head>
<body>

    <div id="stars" class="stars-container"></div>

    <div id="error-view">
        <h1 class="error-code">404</h1>
        <p class="error-msg">Halaman Pembayaran Tidak Valid</p>
        <p style="color: #aaa; font-size: 0.9rem;">Silakan buat ulang link pembayaran Anda.</p>
    </div>

    <div id="payment-view" class="card" style="display: none;">
        <h1>Tagihan Top Up Limit</h1>
        <div class="badge-packet" id="display-packet">Loading...</div>
        
        <div class="country-wrapper">
            <label class="label-custom">Pilih Negara Asal (QRIS Support)</label>
            <select id="countrySelect" class="country-select" onchange="onCountryChange()">
                <option value="" disabled selected>-- Pilih Negara Pembayaran --</option>
                <option value="ID">üáÆüá© Indonesia (IDR)</option>
                <option value="MY">üá≤üáæ Malaysia (MYR)</option>
                <option value="TH">üáπüá≠ Thailand (THB)</option>
                <option value="SG">üá∏üá¨ Singapore (SGD)</option>
            </select>
        </div>

        <div id="qris-area">
            <div class="price-tag" id="display-amount">Rp 0</div>
            <div id="original-amount-display" class="original-price" style="display: none;">(Rp 0)</div>

            <div id="qrcode"></div>

            <div class="instruction-box">
                <strong id="instruction-title">Cara Pembayaran:</strong>
                <ol>
                    <li>Scan QRIS di atas dengan aplikasi E-Wallet/Bank negara Anda.</li>
                    <li>Pastikan nama merchant sesuai.</li>
                    <li>Screenshot bukti sukses bayar.</li>
                    <li>Isi <b>LID</b> & kirim ke Admin.</li>
                </ol>
            </div>
        </div>

        <div class="input-wrapper">
            <label class="label-custom" for="lidUser">Masukan LID Anda</label>
            <input type="text" id="lidUser" class="input-custom" placeholder="Contoh: 12345@lid" autocomplete="off">
            <p class="helper-text">Ketik <b>cekst</b> di bot untuk lihat LID.</p>
        </div>

        <button id="btnKirim" class="btn-wa" onclick="kirimBuktiWhatsApp()" disabled>
            <svg viewBox="0 0 24 24"><path d="M17.472 14.382C17.117 14.205 15.378 13.344 15.053 13.232C14.73 13.12 14.493 13.064 14.257 13.418C14.02 13.771 13.343 14.565 13.136 14.801C12.929 15.036 12.723 15.065 12.368 14.887C12.014 14.71 10.873 14.336 9.52003 13.129C8.45503 12.18 7.73703 11.007 7.53003 10.653C7.32303 10.298 7.50803 10.106 7.68603 9.93002C7.84603 9.77102 8.04103 9.51702 8.21903 9.31002C8.39603 9.10302 8.45603 8.95502 8.57403 8.71902C8.69203 8.48302 8.63303 8.27702 8.54403 8.09902C8.45603 7.92102 7.74703 6.17802 7.45203 5.47102C7.16403 4.78202 6.87303 4.87602 6.65703 4.87602C6.45503 4.87602 6.22003 4.87102 5.98403 4.87102C5.74803 4.87102 5.36503 4.96002 5.04003 5.31402C4.71503 5.66802 3.80103 6.52402 3.80103 8.26402C3.80103 10.005 5.06803 11.687 5.24603 11.922C5.42303 12.158 7.74703 15.742 11.417 17.327C14.155 18.508 14.686 18.291 15.276 18.232C15.867 18.173 17.165 17.485 17.432 16.719C17.697 15.952 17.697 15.293 17.638 15.185C17.579 15.077 17.343 15.018 16.989 14.841H17.472V14.382Z"/></svg>
            Kirim Bukti Pembayaran
        </button>
        <p class="note-footer">Anda akan diarahkan ke WhatsApp untuk mengirim foto bukti.</p>
    </div>

    <script>
        const NOMOR_ADMIN = '6285758412480'; 
        const BASE_PAYLOAD = "00020101021226570011ID.DANA.WWW011893600915051415649802095141564980303UMI51440014ID.CO.QRIS.WWW0215ID10232926833570303UMI520473725303360540430005802ID5907Eg_shop6015Kab. Tulang Baw610534683621960150011ID.DANA.WWW63042C8F";

        const PAKET = {
            10000: { limit: '500 Limit' },
            20000: { limit: '1.000 Limit' },
            40000: { limit: '2.000 Limit' }
        };

        const EXCHANGE_RATES = {
            'ID': { divisor: 1, symbol: 'Rp', lang: 'id-ID' },
            'MY': { divisor: 3450, symbol: 'RM', lang: 'ms-MY' },
            'TH': { divisor: 450, symbol: '‡∏ø', lang: 'th-TH' },
            'SG': { divisor: 11500, symbol: 'S$', lang: 'en-SG' }
        };

        let currentAmountIDR = 0;
        let currentPacketName = "";

        function createStars() {
            const container = document.getElementById('stars');
            const count = 60; 
            for (let i = 0; i < count; i++) {
                const s = document.createElement('div');
                s.className = 'star';
                const size = Math.random() * 2 + 1;
                s.style.width = size + 'px';
                s.style.height = size + 'px';
                s.style.left = Math.random() * 100 + '%';
                s.style.top = Math.random() * 100 + '%';
                s.style.animationDuration = (Math.random() * 2 + 1) + 's';
                container.appendChild(s);
            }
        }
        createStars();

        window.addEventListener('load', init);
        window.addEventListener('hashchange', init);

        function init() {
            const hash = window.location.hash.substring(1); 
            const cleanHash = hash.replace(/\./g, '');
            const amount = parseInt(cleanHash);

            const viewPayment = document.getElementById('payment-view');
            const viewError = document.getElementById('error-view');
            const btnKirim = document.getElementById('btnKirim');
            
            if (!hash || isNaN(amount) || !PAKET[amount]) {
                viewPayment.style.display = 'none';
                viewError.style.display = 'block';
                document.title = "404 - Tidak Ditemukan";
            } else {
                currentAmountIDR = amount;
                currentPacketName = PAKET[amount].limit;
                
                viewError.style.display = 'none';
                viewPayment.style.display = 'block';
                
                // Reset State
                document.getElementById('countrySelect').selectedIndex = 0;
                document.getElementById('qris-area').classList.remove('show');
                document.getElementById('qris-area').style.display = 'none';
                
                // --- RESET TOMBOL JADI DISABLED ---
                btnKirim.disabled = true;

                document.getElementById('display-packet').innerText = `Paket: ${currentPacketName}`;
                document.title = `Bayar Tagihan`;
            }
        }

        function onCountryChange() {
            const select = document.getElementById('countrySelect');
            const countryCode = select.value;
            const qrisArea = document.getElementById('qris-area');
            const displayAmount = document.getElementById('display-amount');
            const originalDisplay = document.getElementById('original-amount-display');
            const btnKirim = document.getElementById('btnKirim');
            
            if (!countryCode) {
                // Jika user entah bagaimana memilih default option lagi
                btnKirim.disabled = true;
                return;
            }

            // --- AKTIFKAN TOMBOL ---
            btnKirim.disabled = false;

            const rateData = EXCHANGE_RATES[countryCode];
            
            let finalDisplayString = "";
            if (countryCode === 'ID') {
                finalDisplayString = `Rp ${currentAmountIDR.toLocaleString('id-ID')}`;
                originalDisplay.style.display = 'none';
            } else {
                const foreignAmount = (currentAmountIDR / rateData.divisor).toFixed(2);
                finalDisplayString = `${rateData.symbol} ${foreignAmount}`;
                originalDisplay.innerText = `(Setara Rp ${currentAmountIDR.toLocaleString('id-ID')})`;
                originalDisplay.style.display = 'block';
            }
            
            displayAmount.innerText = finalDisplayString;

            const qrcodeContainer = document.getElementById('qrcode');
            qrcodeContainer.innerHTML = ""; 
            
            const qrisString = generateQrisPayload(currentAmountIDR); 
            new QRCode(qrcodeContainer, {
                text: qrisString,
                width: 200, 
                height: 200,
                correctLevel : QRCode.CorrectLevel.M
            });

            qrisArea.style.display = 'block';
            setTimeout(() => {
                qrisArea.classList.add('show');
            }, 50);
        }

        function kirimBuktiWhatsApp() {
            // Safety check: Jangan kirim kalau tombol harusnya disabled
            const btnKirim = document.getElementById('btnKirim');
            if (btnKirim.disabled) return;

            const lidInput = document.getElementById('lidUser').value.trim();
            const countrySelect = document.getElementById('countrySelect');
            const countryName = countrySelect.options[countrySelect.selectedIndex].text;

            if (lidInput === "") {
                alert("Harap isi LID Anda terlebih dahulu!");
                document.getElementById('lidUser').focus();
                return;
            }

            if (!lidInput.toLowerCase().includes('@lid')) {
                alert("LID harus pakai @lid (Contoh: 12345@lid)");
                document.getElementById('lidUser').focus();
                return;
            }

            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            const waktu = now.toLocaleDateString('id-ID', options);

            const pesan = 
`*KONFIRMASI PEMBAYARAN*

üÜî *LID:* ${lidInput}
üåç *Negara:* ${countryName}
üìÖ *Waktu:* ${waktu}
üí∞ *Nominal IDR:* Rp ${currentAmountIDR.toLocaleString('id-ID')}
üì¶ *Paket:* ${currentPacketName}

Mohon segera diproses, bukti pembayaran terlampir.`;

            const urlWA = `https://wa.me/${NOMOR_ADMIN}?text=${encodeURIComponent(pesan)}`;
            window.open(urlWA, '_blank');
        }

        function crc16ccitt(str) {
            let crc = 0xFFFF;
            for (let i = 0; i < str.length; i++) {
                crc ^= str.charCodeAt(i) << 8;
                for (let j = 0; j < 8; j++) {
                    crc = (crc & 0x8000) ? ((crc << 1) ^ 0x1021) & 0xFFFF : (crc << 1) & 0xFFFF;
                }
            }
            return crc & 0xFFFF;
        }

        function tlvParse(payload) {
            const out = [];
            let i = 0;
            while (i < payload.length) {
                const tag = payload.substr(i, 2); i += 2;
                const len = parseInt(payload.substr(i, 2), 10); i += 2;
                const val = payload.substr(i, len); i += len;
                out.push({ tag, value: val });
            }
            return out;
        }

        function tlvBuild(list) {
            return list.map(it => {
                const len = String(it.value.length).padStart(2, "0");
                return it.tag + len + it.value;
            }).join('');
        }

        function generateQrisPayload(amount) {
            let amountStr = String(amount).trim().replace(',', '.');
            let items = tlvParse(BASE_PAYLOAD).filter(it => it.tag !== '63');
            
            let found = false;
            for (let it of items) {
                if (it.tag === '54') { it.value = amountStr; found = true; break; }
            }
            if (!found) {
                let idx58 = items.findIndex(it => it.tag === '58');
                if (idx58 === -1) items.push({ tag: '54', value: amountStr });
                else items.splice(idx58, 0, { tag: '54', value: amountStr });
            }

            let partial = tlvBuild(items);
            let toCrc = partial + "6304";
            let crcVal = crc16ccitt(toCrc).toString(16).toUpperCase().padStart(4, '0');
            return toCrc + crcVal;
        }
    </script>
</body>
</html>
